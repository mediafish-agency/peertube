import { inject, Injectable, NgZone } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, map } from 'rxjs/operators';
import { UPLOADX_AJAX } from './ajax';
import { IdService } from './id.service';
import { UPLOADX_FACTORY_OPTIONS, UPLOADX_OPTIONS } from './options';
import { store } from './store';
import { iosOverride, isBrowser, onLine, pick } from './utils';
import * as i0 from "@angular/core";
export const UPLOAD_STATE_KEYS = [
    'file',
    'name',
    'progress',
    'remaining',
    'response',
    'responseHeaders',
    'responseStatus',
    'size',
    'speed',
    'status',
    'uploadId',
    'url'
];
const DUE_TIME = 5;
export class UploadxService {
    constructor() {
        /** Upload Queue */
        this.queue = [];
        this.eventsStream = new Subject();
        this.subs = [];
        this.ngZone = inject(NgZone);
        this.ajax = inject(UPLOADX_AJAX);
        this.idService = inject(IdService);
        this.stateChange = (uploader) => {
            this.ngZone.run(() => this.eventsStream.next(pick(uploader, UPLOAD_STATE_KEYS)));
            if (uploader.status !== 'uploading' && uploader.status !== 'added') {
                this.ngZone.runOutsideAngular(() => setTimeout(() => this.processQueue()));
            }
        };
        const options = inject(UPLOADX_OPTIONS, { optional: true });
        const defaults = inject(UPLOADX_FACTORY_OPTIONS);
        this.options = Object.assign({}, defaults, options);
        if (isBrowser()) {
            this.subs.push(fromEvent(window, 'online').subscribe(() => this.control({ action: 'upload' })), fromEvent(window, 'offline').subscribe(() => this.control({ action: 'pause' })));
        }
    }
    /** Upload status events */
    get events() {
        return this.eventsStream.asObservable();
    }
    /**
     * Initializes service
     * @param options global module options
     * @returns Observable that emits a new value on progress or status changes
     */
    init(options = {}) {
        Object.assign(this.options, options);
        return this.events;
    }
    /**
     * Initializes service
     * @param options global module options
     * @returns Observable that emits the current array of uploaders
     */
    connect(options) {
        return this.init(options).pipe(map(() => this.queue), debounceTime(DUE_TIME));
    }
    /**
     * Terminates all uploads and clears the queue
     */
    disconnect() {
        this.queue.forEach(uploader => (uploader.status = 'paused'));
        this.queue = [];
    }
    /**
     * Returns current uploads state
     * @example
     * // restore background uploads
     * this.uploads = this.uploadService.state();
     */
    state() {
        return this.queue.map(uploader => pick(uploader, UPLOAD_STATE_KEYS));
    }
    ngOnDestroy() {
        this.disconnect();
        this.subs.forEach(sub => sub.unsubscribe());
    }
    /**
     * Creates uploaders for files and adds them to the upload queue
     */
    handleFiles(files, options = {}) {
        const instanceOptions = { ...this.options, ...iosOverride, ...options };
        store.clear(instanceOptions.storeIncompleteHours);
        this.options.concurrency = instanceOptions.concurrency;
        ('name' in files ? [files] : Array.from(files)).forEach(file => this.addUploaderInstance(file, instanceOptions));
    }
    /**
     * Upload control
     * @example
     * // pause all
     * this.uploadService.control({ action: 'pause' });
     * // pause upload with uploadId
     * this.uploadService.control({ action: 'pause', uploadId});
     * // set token
     * this.uploadService.control({ token: `TOKEN` });
     */
    control(evt) {
        const target = evt.uploadId
            ? this.queue.filter(({ uploadId }) => uploadId === evt.uploadId)
            : this.queue;
        target.forEach(uploader => uploader.configure(evt));
    }
    /**
     * Number of active uploads
     */
    get activeUploadsCount() {
        return this.queue.filter(({ status }) => status === 'uploading' || status === 'retry').length;
    }
    /**
     * Performs http requests
     */
    async request(config) {
        config.data || (config.data = config.body);
        return this.ajax.request(config);
    }
    async addUploaderInstance(file, options) {
        const uploader = new options.uploaderClass(file, options, this.stateChange, this.ajax);
        uploader.uploadId = await this.idService.generateId(uploader);
        this.queue.push(uploader);
        uploader.status = 'added';
        if (options.autoUpload && onLine()) {
            uploader.status = 'queue';
        }
    }
    processQueue() {
        this.queue = this.queue.filter(({ status }) => status !== 'cancelled');
        this.queue
            .filter(({ status }) => status === 'queue')
            .slice(0, Math.max(this.options.concurrency - this.activeUploadsCount, 0))
            .forEach(uploader => uploader.upload());
    }
}
UploadxService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: UploadxService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
UploadxService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: UploadxService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: UploadxService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkeC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3VwbG9hZHgvbGliL3VwbG9hZHguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEUsT0FBTyxFQUFFLFNBQVMsRUFBYyxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkQsT0FBTyxFQUFtQyxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdkUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV6QyxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLGVBQWUsRUFHaEIsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVoQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sU0FBUyxDQUFDOztBQUUvRCxNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBMEI7SUFDdEQsTUFBTTtJQUNOLE1BQU07SUFDTixVQUFVO0lBQ1YsV0FBVztJQUNYLFVBQVU7SUFDVixpQkFBaUI7SUFDakIsZ0JBQWdCO0lBQ2hCLE1BQU07SUFDTixPQUFPO0lBQ1AsUUFBUTtJQUNSLFVBQVU7SUFDVixLQUFLO0NBQ04sQ0FBQztBQUVGLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQztBQUduQixNQUFNLE9BQU8sY0FBYztJQVV6QjtRQVRBLG1CQUFtQjtRQUNuQixVQUFLLEdBQWUsRUFBRSxDQUFDO1FBRU4saUJBQVksR0FBeUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUM1RCxTQUFJLEdBQW1CLEVBQUUsQ0FBQztRQUMxQixXQUFNLEdB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TyxDQUFDO2FBQzFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDekUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDNUMsQ0FBQzs7NEdBM0lVLGNBQWM7Z0hBQWQsY0FBYyxjQURELE1BQU07NEZBQ25CLGNBQWM7a0JBRDFCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0LCBJbmplY3RhYmxlLCBOZ1pvbmUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWpheFJlcXVlc3RDb25maWcsIEFqYXhSZXNwb25zZSwgVVBMT0FEWF9BSkFYIH0gZnJvbSAnLi9hamF4JztcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gJy4vaWQuc2VydmljZSc7XG5pbXBvcnQgeyBVcGxvYWRTdGF0ZSwgVXBsb2FkeENvbnRyb2xFdmVudCB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge1xuICBVUExPQURYX0ZBQ1RPUllfT1BUSU9OUyxcbiAgVVBMT0FEWF9PUFRJT05TLFxuICBVcGxvYWR4RmFjdG9yeU9wdGlvbnMsXG4gIFVwbG9hZHhPcHRpb25zXG59IGZyb20gJy4vb3B0aW9ucyc7XG5pbXBvcnQgeyBzdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgVXBsb2FkZXIgfSBmcm9tICcuL3VwbG9hZGVyJztcbmltcG9ydCB7IGlvc092ZXJyaWRlLCBpc0Jyb3dzZXIsIG9uTGluZSwgcGljayB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgVVBMT0FEX1NUQVRFX0tFWVM6IChrZXlvZiBVcGxvYWRTdGF0ZSlbXSA9IFtcbiAgJ2ZpbGUnLFxuICAnbmFtZScsXG4gICdwcm9ncmVzcycsXG4gICdyZW1haW5pbmcnLFxuICAncmVzcG9uc2UnLFxuICAncmVzcG9uc2VIZWFkZXJzJyxcbiAgJ3Jlc3BvbnNlU3RhdHVzJyxcbiAgJ3NpemUnLFxuICAnc3BlZWQnLFxuICAnc3RhdHVzJyxcbiAgJ3VwbG9hZElkJyxcbiAgJ3VybCdcbl07XG5cbmNvbnN0IERVRV9USU1FID0gNTtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBVcGxvYWR4U2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIC8qKiBVcGxvYWQgUXVldWUgKi9cbiAgcXVldWU6IFVwbG9hZGVyW10gPSBbXTtcbiAgcmVhZG9ubHkgb3B0aW9uczogVXBsb2FkeEZhY3RvcnlPcHRpb25zO1xuICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50c1N0cmVhbTogU3ViamVjdDxVcGxvYWRTdGF0ZT4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIHN1YnM6IFN1YnNjcmlwdGlvbltdID0gW107XG4gIHByaXZhdGUgbmdab25lID0gaW5qZWN0KE5nWm9uZSk7XG4gIHJlYWRvbmx5IGFqYXggPSBpbmplY3QoVVBMT0FEWF9BSkFYKTtcbiAgcHJpdmF0ZSBpZFNlcnZpY2UgPSBpbmplY3QoSWRTZXJ2aWNlKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBjb25zdCBvcHRpb25zID0gaW5qZWN0KFVQTE9BRFhfT1BUSU9OUywgeyBvcHRpb25hbDogdHJ1ZSB9KTtcbiAgICBjb25zdCBkZWZhdWx0cyA9IGluamVjdChVUExPQURYX0ZBQ1RPUllfT1BUSU9OUyk7XG4gICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdHMsIG9wdGlvbnMpO1xuICAgIGlmIChpc0Jyb3dzZXIoKSkge1xuICAgICAgdGhpcy5zdWJzLnB1c2goXG4gICAgICAgIGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5jb250cm9sKHsgYWN0aW9uOiAndXBsb2FkJyB9KSksXG4gICAgICAgIGZyb21FdmVudCh3aW5kb3csICdvZmZsaW5lJykuc3Vic2NyaWJlKCgpID0+IHRoaXMuY29udHJvbCh7IGFjdGlvbjogJ3BhdXNlJyB9KSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqIFVwbG9hZCBzdGF0dXMgZXZlbnRzICovXG4gIGdldCBldmVudHMoKTogT2JzZXJ2YWJsZTxVcGxvYWRTdGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLmV2ZW50c1N0cmVhbS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBzZXJ2aWNlXG4gICAqIEBwYXJhbSBvcHRpb25zIGdsb2JhbCBtb2R1bGUgb3B0aW9uc1xuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIHRoYXQgZW1pdHMgYSBuZXcgdmFsdWUgb24gcHJvZ3Jlc3Mgb3Igc3RhdHVzIGNoYW5nZXNcbiAgICovXG4gIGluaXQob3B0aW9uczogVXBsb2FkeE9wdGlvbnMgPSB7fSk6IE9ic2VydmFibGU8VXBsb2FkU3RhdGU+IHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMub3B0aW9ucywgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHNlcnZpY2VcbiAgICogQHBhcmFtIG9wdGlvbnMgZ2xvYmFsIG1vZHVsZSBvcHRpb25zXG4gICAqIEByZXR1cm5zIE9ic2VydmFibGUgdGhhdCBlbWl0cyB0aGUgY3VycmVudCBhcnJheSBvZiB1cGxvYWRlcnNcbiAgICovXG4gIGNvbm5lY3Qob3B0aW9ucz86IFVwbG9hZHhPcHRpb25zKTogT2JzZXJ2YWJsZTxVcGxvYWRlcltdPiB7XG4gICAgcmV0dXJuIHRoaXMuaW5pdChvcHRpb25zKS5waXBlKFxuICAgICAgbWFwKCgpID0+IHRoaXMucXVldWUpLFxuICAgICAgZGVib3VuY2VUaW1lKERVRV9USU1FKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVGVybWluYXRlcyBhbGwgdXBsb2FkcyBhbmQgY2xlYXJzIHRoZSBxdWV1ZVxuICAgKi9cbiAgZGlzY29ubmVjdCgpOiB2b2lkIHtcbiAgICB0aGlzLnF1ZXVlLmZvckVhY2godXBsb2FkZXIgPT4gKHVwbG9hZGVyLnN0YXR1cyA9ICdwYXVzZWQnKSk7XG4gICAgdGhpcy5xdWV1ZSA9IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgY3VycmVudCB1cGxvYWRzIHN0YXRlXG4gICAqIEBleGFtcGxlXG4gICAqIC8vIHJlc3RvcmUgYmFja2dyb3VuZCB1cGxvYWRzXG4gICAqIHRoaXMudXBsb2FkcyA9IHRoaXMudXBsb2FkU2VydmljZS5zdGF0ZSgpO1xuICAgKi9cbiAgc3RhdGUoKTogVXBsb2FkU3RhdGVbXSB7XG4gICAgcmV0dXJuIHRoaXMucXVldWUubWFwKHVwbG9hZGVyID0+IHBpY2sodXBsb2FkZXIsIFVQTE9BRF9TVEFURV9LRVlTKSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLnN1YnMuZm9yRWFjaChzdWIgPT4gc3ViLnVuc3Vic2NyaWJlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgdXBsb2FkZXJzIGZvciBmaWxlcyBhbmQgYWRkcyB0aGVtIHRvIHRoZSB1cGxvYWQgcXVldWVcbiAgICovXG4gIGhhbmRsZUZpbGVzKGZpbGVzOiBGaWxlTGlzdCB8IEZpbGUgfCBGaWxlW10sIG9wdGlvbnMgPSB7fSBhcyBVcGxvYWR4T3B0aW9ucyk6IHZvaWQge1xuICAgIGNvbnN0IGluc3RhbmNlT3B0aW9uczogVXBsb2FkeEZhY3RvcnlPcHRpb25zID0geyAuLi50aGlzLm9wdGlvbnMsIC4uLmlvc092ZXJyaWRlLCAuLi5vcHRpb25zIH07XG4gICAgc3RvcmUuY2xlYXIoaW5zdGFuY2VPcHRpb25zLnN0b3JlSW5jb21wbGV0ZUhvdXJzKTtcbiAgICB0aGlzLm9wdGlvbnMuY29uY3VycmVuY3kgPSBpbnN0YW5jZU9wdGlvbnMuY29uY3VycmVuY3k7XG4gICAgKCduYW1lJyBpbiBmaWxlcyA/IFtmaWxlc10gOiBBcnJheS5mcm9tKGZpbGVzKSkuZm9yRWFjaChmaWxlID0+XG4gICAgICB0aGlzLmFkZFVwbG9hZGVySW5zdGFuY2UoZmlsZSwgaW5zdGFuY2VPcHRpb25zKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVXBsb2FkIGNvbnRyb2xcbiAgICogQGV4YW1wbGVcbiAgICogLy8gcGF1c2UgYWxsXG4gICAqIHRoaXMudXBsb2FkU2VydmljZS5jb250cm9sKHsgYWN0aW9uOiAncGF1c2UnIH0pO1xuICAgKiAvLyBwYXVzZSB1cGxvYWQgd2l0aCB1cGxvYWRJZFxuICAgKiB0aGlzLnVwbG9hZFNlcnZpY2UuY29udHJvbCh7IGFjdGlvbjogJ3BhdXNlJywgdXBsb2FkSWR9KTtcbiAgICogLy8gc2V0IHRva2VuXG4gICAqIHRoaXMudXBsb2FkU2VydmljZS5jb250cm9sKHsgdG9rZW46IGBUT0tFTmAgfSk7XG4gICAqL1xuICBjb250cm9sKGV2dDogVXBsb2FkeENvbnRyb2xFdmVudCk6IHZvaWQge1xuICAgIGNvbnN0IHRhcmdldCA9IGV2dC51cGxvYWRJZFxuICAgICAgPyB0aGlzLnF1ZXVlLmZpbHRlcigoeyB1cGxvYWRJZCB9KSA9PiB1cGxvYWRJZCA9PT0gZXZ0LnVwbG9hZElkKVxuICAgICAgOiB0aGlzLnF1ZXVlO1xuICAgIHRhcmdldC5mb3JFYWNoKHVwbG9hZGVyID0+IHVwbG9hZGVyLmNvbmZpZ3VyZShldnQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBOdW1iZXIgb2YgYWN0aXZlIHVwbG9hZHNcbiAgICovXG4gIGdldCBhY3RpdmVVcGxvYWRzQ291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZS5maWx0ZXIoKHsgc3RhdHVzIH0pID0+IHN0YXR1cyA9PT0gJ3VwbG9hZGluZycgfHwgc3RhdHVzID09PSAncmV0cnknKS5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgaHR0cCByZXF1ZXN0c1xuICAgKi9cbiAgYXN5bmMgcmVxdWVzdDxUID0gc3RyaW5nPihjb25maWc6IEFqYXhSZXF1ZXN0Q29uZmlnKTogUHJvbWlzZTxBamF4UmVzcG9uc2U8VD4+IHtcbiAgICBjb25maWcuZGF0YSB8fD0gY29uZmlnLmJvZHk7XG4gICAgcmV0dXJuIHRoaXMuYWpheC5yZXF1ZXN0KGNvbmZpZyk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRlQ2hhbmdlID0gKHVwbG9hZGVyOiBVcGxvYWRlcikgPT4ge1xuICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmV2ZW50c1N0cmVhbS5uZXh0KHBpY2sodXBsb2FkZXIsIFVQTE9BRF9TVEFURV9LRVlTKSkpO1xuICAgIGlmICh1cGxvYWRlci5zdGF0dXMgIT09ICd1cGxvYWRpbmcnICYmIHVwbG9hZGVyLnN0YXR1cyAhPT0gJ2FkZGVkJykge1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gc2V0VGltZW91dCgoKSA9PiB0aGlzLnByb2Nlc3NRdWV1ZSgpKSk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgYXN5bmMgYWRkVXBsb2FkZXJJbnN0YW5jZShmaWxlOiBGaWxlLCBvcHRpb25zOiBVcGxvYWR4RmFjdG9yeU9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB1cGxvYWRlciA9IG5ldyBvcHRpb25zLnVwbG9hZGVyQ2xhc3MoZmlsZSwgb3B0aW9ucywgdGhpcy5zdGF0ZUNoYW5nZSwgdGhpcy5hamF4KTtcbiAgICAodXBsb2FkZXIgYXMgeyB1cGxvYWRJZDogc3RyaW5nIH0pLnVwbG9hZElkID0gYXdhaXQgdGhpcy5pZFNlcnZpY2UuZ2VuZXJhdGVJZCh1cGxvYWRlcik7XG4gICAgdGhpcy5xdWV1ZS5wdXNoKHVwbG9hZGVyKTtcbiAgICB1cGxvYWRlci5zdGF0dXMgPSAnYWRkZWQnO1xuICAgIGlmIChvcHRpb25zLmF1dG9VcGxvYWQgJiYgb25MaW5lKCkpIHtcbiAgICAgIHVwbG9hZGVyLnN0YXR1cyA9ICdxdWV1ZSc7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzUXVldWUoKTogdm9pZCB7XG4gICAgdGhpcy5xdWV1ZSA9IHRoaXMucXVldWUuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXMgIT09ICdjYW5jZWxsZWQnKTtcbiAgICB0aGlzLnF1ZXVlXG4gICAgICAuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXMgPT09ICdxdWV1ZScpXG4gICAgICAuc2xpY2UoMCwgTWF0aC5tYXgodGhpcy5vcHRpb25zLmNvbmN1cnJlbmN5IC0gdGhpcy5hY3RpdmVVcGxvYWRzQ291bnQsIDApKVxuICAgICAgLmZvckVhY2godXBsb2FkZXIgPT4gdXBsb2FkZXIudXBsb2FkKCkpO1xuICB9XG59XG4iXX0=
import { Canceler } from './canceler';
import { DynamicChunk } from './dynamic-chunk';
import { ErrorType, RetryHandler } from './retry-handler';
import { store } from './store';
import { isNumber, unfunc } from './utils';
const actionToStatusMap = {
    pause: 'paused',
    upload: 'queue',
    cancel: 'cancelled',
    update: 'updated'
};
/**
 * Uploader Base Class
 */
export class Uploader {
    constructor(file, options, stateChange, ajax) {
        this.file = file;
        this.options = options;
        this.stateChange = stateChange;
        this.ajax = ajax;
        this.response = null;
        this.responseStatus = 0;
        this.responseHeaders = {};
        this.progress = 0;
        this.speed = 0;
        /** Custom headers */
        this.headers = {};
        /** Upload endpoint */
        this.endpoint = '/upload';
        /** Chunk size in bytes */
        this.chunkSize = 0;
        this.canceler = new Canceler();
        this.abortController = new AbortController();
        this._eventsCount = 0;
        this._url = '';
        /**
         * Set auth token string
         */
        this.updateToken = () => {
            return unfunc(this.token || '', this.responseStatus);
        };
        this.cleanup = () => {
            store.delete(this._url);
            store.delete(this.uploadId);
        };
        this.retry = new RetryHandler(options.retryConfig);
        this.name = file.name;
        this.size = file.size;
        this.metadata = {
            name: file.name,
            mimeType: file.type || 'application/octet-stream',
            size: file.size,
            lastModified: file.lastModified
        };
        options.maxChunkSize && (DynamicChunk.maxSize = options.maxChunkSize);
        this._prerequest = options.prerequest || (req => req);
        this._authorize = options.authorize || (req => req);
        this.configure(options);
    }
    get url() {
        return this._url || store.get(this.uploadId) || '';
    }
    set url(value) {
        this._url !== value && store.set(this.uploadId, value);
        this._url = value;
    }
    get status() {
        return this._status;
    }
    set status(s) {
        if (s !== 'updated' && s !== 'cancelled') {
            if (this._status === s)
                return;
            if (this._status === 'complete')
                return;
        }
        if (this._status === 'cancelled')
            return;
        if (this._status === 'uploading' && s === 'queue')
            return;
        if (this._status === 'retry')
            this.retry.cancel();
        this._status = s;
        if (s === 'paused')
            this.abort();
        if (s === 'cancelled' || s === 'complete' || s === 'error')
            this.cleanup();
        if (s === 'cancelled')
            this.cancelAndSendState();
        else if (s === 'updated')
            this.updateAndSendState();
        else
            this.stateChange(this);
    }
    /**
     * Configure uploader
     */
    configure({ metadata, headers, token, endpoint, action }) {
        endpoint && (this.endpoint = endpoint);
        token && (this.token = token);
        metadata && Object.assign(this.metadata, unfunc(metadata, this.file));
        headers && Object.assign(this.headers, unfunc(headers, this.file));
        action && (this.status = actionToStatusMap[action]);
    }
    /**
     * Starts uploading
     */
    async upload() {
        do {
            this.status = 'uploading';
            try {
                this._token || (this._token = await this.updateToken());
                this.url || (this.url = await this.getFileUrl());
                if (this.offset !== this.size) {
                    this.offset = isNumber(this.offset)
                        ? await this.sendFileContent()
                        : await this.getOffset();
                }
                this.retry.observe(this.offset);
                if (this.offset === this.size) {
                    this.remaining = 0;
                    this.progress = 100;
                    this.status = 'complete';
                }
                else if (!isNumber(this.offset)) {
                    this.stateChange(this);
                    await this.retry.wait(this.getRetryAfterFromBackend() || this.retry.config.onBusyDelay);
                }
            }
            catch (e) {
                e instanceof Error && console.error(e);
                if (this.status !== 'uploading') {
                    return;
                }
                switch (this.retry.kind(this.responseStatus)) {
                    case ErrorType.Fatal:
                        this.status = 'error';
                        return;
                    case ErrorType.NotFound:
                        this.url = '';
                        break;
                    case ErrorType.Auth:
                        this._token = '';
                        break;
                    default:
                        if (unfunc(this.retry.config.keepPartial, this.responseStatus)) {
                            this.offset = undefined;
                        }
                        this.status = 'retry';
                        await this.retry.wait(this.getRetryAfterFromBackend());
                }
            }
        } while (['uploading', 'retry', 'updated'].includes(this._status));
    }
    /**
     * Performs http requests
     */
    async request(requestOptions) {
        this.responseStatus = 0;
        this.response = null;
        this.responseHeaders = {};
        if (this.abortController.signal.aborted) {
            this.abortController = new AbortController();
        }
        const signal = requestOptions.signal || this.abortController.signal;
        let req = {
            body: requestOptions.body || null,
            canceler: this.canceler,
            signal,
            headers: { ...this.headers, ...requestOptions.headers },
            method: requestOptions.method || 'GET',
            url: requestOptions.url || this.url
        };
        if (!requestOptions.skipAuthorization) {
            req = await this._authorize(req, this._token);
        }
        const { body = null, headers, method, url = req.url } = (await this._prerequest(req)) || req;
        const ajaxRequestConfig = {
            method,
            headers: { ...req.headers, ...headers },
            url,
            data: body,
            responseType: this.options.responseType ?? this.responseType,
            withCredentials: !!this.options.withCredentials,
            canceler: this.canceler,
            signal,
            validateStatus: () => true,
            timeout: this.retry.config.timeout
        };
        if (isNumber(this.offset) && body && typeof body === 'object') {
            ajaxRequestConfig.onUploadProgress = this.onProgress();
        }
        const response = await this.ajax.request(ajaxRequestConfig);
        this.response = response.data;
        this.responseHeaders = response.headers;
        this.responseStatus = response.status;
        if (response.status >= 400) {
            return Promise.reject();
        }
    }
    /**
     *  Updating the metadata of the upload
     */
    update(_data) {
        return Promise.reject('Not implemented');
    }
    abort() {
        this.offset = undefined;
        this.abortController.abort();
        this.canceler.cancel();
    }
    async cancel() {
        this.abort();
        if (this.url) {
            await this.request({ method: 'DELETE' }).catch(() => { });
        }
    }
    /**
     * Gets the value from the response
     */
    getValueFromResponse(key) {
        return this.responseHeaders[key.toLowerCase()] || null;
    }
    /**
     * Get file chunk
     * @param offset - number of bytes of the file to skip
     * @param size - chunk size
     */
    getChunk(offset, size) {
        if (this.responseStatus === 413) {
            DynamicChunk.maxSize = DynamicChunk.size = Math.floor(DynamicChunk.size / 2);
        }
        this.chunkSize =
            this.options.chunkSize === 0 ? this.size : this.options.chunkSize || DynamicChunk.size;
        const start = offset ?? this.offset ?? 0;
        const end = Math.min(start + (size || this.chunkSize), this.size);
        const body = this.file.slice(start, end);
        return { start, end, body };
    }
    getRetryAfterFromBackend() {
        return Number(this.getValueFromResponse('retry-after')) * 1000;
    }
    cancelAndSendState() {
        this.cancel().then(() => this.stateChange(this), console.error);
    }
    updateAndSendState() {
        this.update({ metadata: this.metadata }).then(() => this.stateChange(this), console.error);
    }
    onProgress() {
        let throttle;
        const startTime = Date.now();
        return ({ loaded }) => {
            const current = loaded / ((Date.now() - startTime) / 1000);
            this.speed = ~~((this.speed * this._eventsCount + current) / ++this._eventsCount);
            DynamicChunk.scale(this.speed);
            if (!throttle) {
                throttle = setTimeout(() => (throttle = undefined), 500);
                const uploaded = (this.offset || 0) + loaded;
                this.progress = +((uploaded / this.size) * 100).toFixed(2);
                this.remaining = ~~((this.size - uploaded) / this.speed);
                this.stateChange(this);
            }
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvdXBsb2FkeC9saWIvdXBsb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFlL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTNDLE1BQU0saUJBQWlCLEdBQTBDO0lBQy9ELEtBQUssRUFBRSxRQUFRO0lBQ2YsTUFBTSxFQUFFLE9BQU87SUFDZixNQUFNLEVBQUUsV0FBVztJQUNuQixNQUFNLEVBQUUsU0FBUztDQUNsQixDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLFFBQVE7SUFpQzVCLFlBQ1csSUFBVSxFQUNWLE9BQWtDLEVBQ2xDLFdBQXlDLEVBQ3pDLElBQVU7UUFIVixTQUFJLEdBQUosSUFBSSxDQUFNO1FBQ1YsWUFBTyxHQUFQLE9BQU8sQ0FBMkI7UUFDbEMsZ0JBQVcsR0FBWCxXQUFXLENBQThCO1FBQ3pDLFNBQUksR0FBSixJQUFJLENBQU07UUFqQ3JCLGFBQVEsR0FBaUIsSUFBSSxDQUFDO1FBQzlCLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLG9CQUFlLEdBQTJCLEVBQUUsQ0FBQztRQUM3QyxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRWIsVUFBSyxHQUFHLENBQUMsQ0FBQztRQUNWLHFCQUFxQjtRQUNyQixZQUFPLEdBQW1CLEVBQUUsQ0FBQztRQUc3QixzQkFBc0I7UUFDdEIsYUFBUSxHQUFHLFNBQVMsQ0FBQztRQUNyQiwwQkFBMEI7UUFDMUIsY0FBUyxHQUFH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QUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7Z0JBQzdDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNELElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDekQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4QjtRQUNILENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFqYXgsIEFqYXhSZXF1ZXN0Q29uZmlnIH0gZnJvbSAnLi9hamF4JztcbmltcG9ydCB7IENhbmNlbGVyIH0gZnJvbSAnLi9jYW5jZWxlcic7XG5pbXBvcnQgeyBEeW5hbWljQ2h1bmsgfSBmcm9tICcuL2R5bmFtaWMtY2h1bmsnO1xuaW1wb3J0IHtcbiAgQXV0aG9yaXplUmVxdWVzdCxcbiAgTWV0YWRhdGEsXG4gIFByZVJlcXVlc3QsXG4gIFJlcXVlc3RDb25maWcsXG4gIFJlcXVlc3RIZWFkZXJzLFxuICBSZXF1ZXN0T3B0aW9ucyxcbiAgUmVzcG9uc2VCb2R5LFxuICBVcGxvYWRBY3Rpb24sXG4gIFVwbG9hZGVyT3B0aW9ucyxcbiAgVXBsb2FkU3RhdGUsXG4gIFVwbG9hZFN0YXR1cyxcbiAgVXBsb2FkeENvbnRyb2xFdmVudFxufSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgRXJyb3JUeXBlLCBSZXRyeUhhbmRsZXIgfSBmcm9tICcuL3JldHJ5LWhhbmRsZXInO1xuaW1wb3J0IHsgc3RvcmUgfSBmcm9tICcuL3N0b3JlJztcbmltcG9ydCB7IGlzTnVtYmVyLCB1bmZ1bmMgfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgYWN0aW9uVG9TdGF0dXNNYXA6IHsgW0sgaW4gVXBsb2FkQWN0aW9uXTogVXBsb2FkU3RhdHVzIH0gPSB7XG4gIHBhdXNlOiAncGF1c2VkJyxcbiAgdXBsb2FkOiAncXVldWUnLFxuICBjYW5jZWw6ICdjYW5jZWxsZWQnLFxuICB1cGRhdGU6ICd1cGRhdGVkJ1xufTtcblxuLyoqXG4gKiBVcGxvYWRlciBCYXNlIENsYXNzXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBVcGxvYWRlciBpbXBsZW1lbnRzIFVwbG9hZFN0YXRlIHtcbiAgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSBzaXplOiBudW1iZXI7XG4gIHJlYWRvbmx5IHVwbG9hZElkITogc3RyaW5nO1xuICByZXNwb25zZTogUmVzcG9uc2VCb2R5ID0gbnVsbDtcbiAgcmVzcG9uc2VTdGF0dXMgPSAwO1xuICByZXNwb25zZUhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgcHJvZ3Jlc3MgPSAwO1xuICByZW1haW5pbmchOiBudW1iZXI7XG4gIHNwZWVkID0gMDtcbiAgLyoqIEN1c3RvbSBoZWFkZXJzICovXG4gIGhlYWRlcnM6IFJlcXVlc3RIZWFkZXJzID0ge307XG4gIC8qKiBNZXRhZGF0YSBPYmplY3QgKi9cbiAgbWV0YWRhdGE6IE1ldGFkYXRhO1xuICAvKiogVXBsb2FkIGVuZHBvaW50ICovXG4gIGVuZHBvaW50ID0gJy91cGxvYWQnO1xuICAvKiogQ2h1bmsgc2l6ZSBpbiBieXRlcyAqL1xuICBjaHVua1NpemUgPSAwO1xuICAvKiogQXV0aCB0b2tlbi90b2tlbkdldHRlciAqL1xuICB0b2tlbjogVXBsb2FkeENvbnRyb2xFdmVudFsndG9rZW4nXTtcbiAgLyoqIEJ5dGUgb2Zmc2V0IHdpdGhpbiB0aGUgd2hvbGUgZmlsZSAqL1xuICBvZmZzZXQ/OiBudW1iZXI7XG4gIC8qKiBSZXRyaWVzIGhhbmRsZXIgKi9cbiAgcmV0cnk6IFJldHJ5SGFuZGxlcjtcbiAgY2FuY2VsZXIgPSBuZXcgQ2FuY2VsZXIoKTtcbiAgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAvKiogU2V0IEh0dHBSZXF1ZXN0IHJlc3BvbnNlVHlwZSAqL1xuICByZXNwb25zZVR5cGU/OiAnanNvbicgfCAndGV4dCcgfCAnZG9jdW1lbnQnO1xuICBwcml2YXRlIF9ldmVudHNDb3VudCA9IDA7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2F1dGhvcml6ZTogQXV0aG9yaXplUmVxdWVzdDtcbiAgcHJpdmF0ZSByZWFkb25seSBfcHJlcmVxdWVzdDogUHJlUmVxdWVzdDtcbiAgcHJpdmF0ZSBfdG9rZW4hOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgZmlsZTogRmlsZSxcbiAgICByZWFkb25seSBvcHRpb25zOiBSZWFkb25seTxVcGxvYWRlck9wdGlvbnM+LFxuICAgIHJlYWRvbmx5IHN0YXRlQ2hhbmdlOiAodXBsb2FkZXI6IFVwbG9hZGVyKSA9PiB2b2lkLFxuICAgIHJlYWRvbmx5IGFqYXg6IEFqYXhcbiAgKSB7XG4gICAgdGhpcy5yZXRyeSA9IG5ldyBSZXRyeUhhbmRsZXIob3B0aW9ucy5yZXRyeUNvbmZpZyk7XG4gICAgdGhpcy5uYW1lID0gZmlsZS5uYW1lO1xuICAgIHRoaXMuc2l6ZSA9IGZpbGUuc2l6ZTtcbiAgICB0aGlzLm1ldGFkYXRhID0ge1xuICAgICAgbmFtZTogZmlsZS5uYW1lLFxuICAgICAgbWltZVR5cGU6IGZpbGUudHlwZSB8fCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgIHNpemU6IGZpbGUuc2l6ZSxcbiAgICAgIGxhc3RNb2RpZmllZDogZmlsZS5sYXN0TW9kaWZpZWRcbiAgICB9O1xuICAgIG9wdGlvbnMubWF4Q2h1bmtTaXplICYmIChEeW5hbWljQ2h1bmsubWF4U2l6ZSA9IG9wdGlvbnMubWF4Q2h1bmtTaXplKTtcbiAgICB0aGlzLl9wcmVyZXF1ZXN0ID0gb3B0aW9ucy5wcmVyZXF1ZXN0IHx8IChyZXEgPT4gcmVxKTtcbiAgICB0aGlzLl9hdXRob3JpemUgPSBvcHRpb25zLmF1dGhvcml6ZSB8fCAocmVxID0+IHJlcSk7XG4gICAgdGhpcy5jb25maWd1cmUob3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIF91cmwgPSAnJztcblxuICBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX3VybCB8fCBzdG9yZS5nZXQodGhpcy51cGxvYWRJZCkgfHwgJyc7XG4gIH1cblxuICBzZXQgdXJsKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl91cmwgIT09IHZhbHVlICYmIHN0b3JlLnNldCh0aGlzLnVwbG9hZElkLCB2YWx1ZSk7XG4gICAgdGhpcy5fdXJsID0gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIF9zdGF0dXMhOiBVcGxvYWRTdGF0dXM7XG5cbiAgZ2V0IHN0YXR1cygpOiBVcGxvYWRTdGF0dXMge1xuICAgIHJldHVybiB0aGlzLl9zdGF0dXM7XG4gIH1cblxuICBzZXQgc3RhdHVzKHM6IFVwbG9hZFN0YXR1cykge1xuICAgIGlmIChzICE9PSAndXBkYXRlZCcgJiYgcyAhPT0gJ2NhbmNlbGxlZCcpIHtcbiAgICAgIGlmICh0aGlzLl9zdGF0dXMgPT09IHMpIHJldHVybjtcbiAgICAgIGlmICh0aGlzLl9zdGF0dXMgPT09ICdjb21wbGV0ZScpIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpIHJldHVybjtcbiAgICBpZiAodGhpcy5fc3RhdHVzID09PSAndXBsb2FkaW5nJyAmJiBzID09PSAncXVldWUnKSByZXR1cm47XG4gICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gJ3JldHJ5JykgdGhpcy5yZXRyeS5jYW5jZWwoKTtcbiAgICB0aGlzLl9zdGF0dXMgPSBzO1xuICAgIGlmIChzID09PSAncGF1c2VkJykgdGhpcy5hYm9ydCgpO1xuICAgIGlmIChzID09PSAnY2FuY2VsbGVkJyB8fCBzID09PSAnY29tcGxldGUnIHx8IHMgPT09ICdlcnJvcicpIHRoaXMuY2xlYW51cCgpO1xuICAgIGlmIChzID09PSAnY2FuY2VsbGVkJykgdGhpcy5jYW5jZWxBbmRTZW5kU3RhdGUoKTtcbiAgICBlbHNlIGlmIChzID09PSAndXBkYXRlZCcpIHRoaXMudXBkYXRlQW5kU2VuZFN0YXRlKCk7XG4gICAgZWxzZSB0aGlzLnN0YXRlQ2hhbmdlKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyZSB1cGxvYWRlclxuICAgKi9cbiAgY29uZmlndXJlKHsgbWV0YWRhdGEsIGhlYWRlcnMsIHRva2VuLCBlbmRwb2ludCwgYWN0aW9uIH06IFVwbG9hZHhDb250cm9sRXZlbnQpOiB2b2lkIHtcbiAgICBlbmRwb2ludCAmJiAodGhpcy5lbmRwb2ludCA9IGVuZHBvaW50KTtcbiAgICB0b2tlbiAmJiAodGhpcy50b2tlbiA9IHRva2VuKTtcbiAgICBtZXRhZGF0YSAmJiBPYmplY3QuYXNzaWduKHRoaXMubWV0YWRhdGEsIHVuZnVuYyhtZXRhZGF0YSwgdGhpcy5maWxlKSk7XG4gICAgaGVhZGVycyAmJiBPYmplY3QuYXNzaWduKHRoaXMuaGVhZGVycywgdW5mdW5jKGhlYWRlcnMsIHRoaXMuZmlsZSkpO1xuICAgIGFjdGlvbiAmJiAodGhpcy5zdGF0dXMgPSBhY3Rpb25Ub1N0YXR1c01hcFthY3Rpb25dKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgdXBsb2FkaW5nXG4gICAqL1xuICBhc3luYyB1cGxvYWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgZG8ge1xuICAgICAgdGhpcy5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuX3Rva2VuIHx8PSBhd2FpdCB0aGlzLnVwZGF0ZVRva2VuKCk7XG4gICAgICAgIHRoaXMudXJsIHx8PSBhd2FpdCB0aGlzLmdldEZpbGVVcmwoKTtcbiAgICAgICAgaWYgKHRoaXMub2Zmc2V0ICE9PSB0aGlzLnNpemUpIHtcbiAgICAgICAgICB0aGlzLm9mZnNldCA9IGlzTnVtYmVyKHRoaXMub2Zmc2V0KVxuICAgICAgICAgICAgPyBhd2FpdCB0aGlzLnNlbmRGaWxlQ29udGVudCgpXG4gICAgICAgICAgICA6IGF3YWl0IHRoaXMuZ2V0T2Zmc2V0KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZXRyeS5vYnNlcnZlKHRoaXMub2Zmc2V0KTtcbiAgICAgICAgaWYgKHRoaXMub2Zmc2V0ID09PSB0aGlzLnNpemUpIHtcbiAgICAgICAgICB0aGlzLnJlbWFpbmluZyA9IDA7XG4gICAgICAgICAgdGhpcy5wcm9ncmVzcyA9IDEwMDtcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9ICdjb21wbGV0ZSc7XG4gICAgICAgIH0gZWxzZSBpZiAoIWlzTnVtYmVyKHRoaXMub2Zmc2V0KSkge1xuICAgICAgICAgIHRoaXMuc3RhdGVDaGFuZ2UodGhpcyk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5yZXRyeS53YWl0KHRoaXMuZ2V0UmV0cnlBZnRlckZyb21CYWNrZW5kKCkgfHwgdGhpcy5yZXRyeS5jb25maWcub25CdXN5RGVsYXkpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGUgaW5zdGFuY2VvZiBFcnJvciAmJiBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgIT09ICd1cGxvYWRpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHN3aXRjaCAodGhpcy5yZXRyeS5raW5kKHRoaXMucmVzcG9uc2VTdGF0dXMpKSB7XG4gICAgICAgICAgY2FzZSBFcnJvclR5cGUuRmF0YWw6XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgY2FzZSBFcnJvclR5cGUuTm90Rm91bmQ6XG4gICAgICAgICAgICB0aGlzLnVybCA9ICcnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBFcnJvclR5cGUuQXV0aDpcbiAgICAgICAgICAgIHRoaXMuX3Rva2VuID0gJyc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgaWYgKHVuZnVuYyh0aGlzLnJldHJ5LmNvbmZpZy5rZWVwUGFydGlhbCwgdGhpcy5yZXNwb25zZVN0YXR1cykpIHtcbiAgICAgICAgICAgICAgdGhpcy5vZmZzZXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9ICdyZXRyeSc7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJldHJ5LndhaXQodGhpcy5nZXRSZXRyeUFmdGVyRnJvbUJhY2tlbmQoKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IHdoaWxlIChbJ3VwbG9hZGluZycsICdyZXRyeScsICd1cGRhdGVkJ10uaW5jbHVkZXModGhpcy5fc3RhdHVzKSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgaHR0cCByZXF1ZXN0c1xuICAgKi9cbiAgYXN5bmMgcmVxdWVzdChyZXF1ZXN0T3B0aW9uczogUmVxdWVzdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLnJlc3BvbnNlU3RhdHVzID0gMDtcbiAgICB0aGlzLnJlc3BvbnNlID0gbnVsbDtcbiAgICB0aGlzLnJlc3BvbnNlSGVhZGVycyA9IHt9O1xuICAgIGlmICh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgdGhpcy5hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgfVxuICAgIGNvbnN0IHNpZ25hbCA9IHJlcXVlc3RPcHRpb25zLnNpZ25hbCB8fCB0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWw7XG4gICAgbGV0IHJlcTogUmVxdWVzdENvbmZpZyA9IHtcbiAgICAgIGJvZHk6IHJlcXVlc3RPcHRpb25zLmJvZHkgfHwgbnVsbCxcbiAgICAgIGNhbmNlbGVyOiB0aGlzLmNhbmNlbGVyLFxuICAgICAgc2lnbmFsLFxuICAgICAgaGVhZGVyczogeyAuLi50aGlzLmhlYWRlcnMsIC4uLnJlcXVlc3RPcHRpb25zLmhlYWRlcnMgfSxcbiAgICAgIG1ldGhvZDogcmVxdWVzdE9wdGlvbnMubWV0aG9kIHx8ICdHRVQnLFxuICAgICAgdXJsOiByZXF1ZXN0T3B0aW9ucy51cmwgfHwgdGhpcy51cmxcbiAgICB9O1xuICAgIGlmICghcmVxdWVzdE9wdGlvbnMuc2tpcEF1dGhvcml6YXRpb24pIHtcbiAgICAgIHJlcSA9IGF3YWl0IHRoaXMuX2F1dGhvcml6ZShyZXEsIHRoaXMuX3Rva2VuKTtcbiAgICB9XG4gICAgY29uc3QgeyBib2R5ID0gbnVsbCwgaGVhZGVycywgbWV0aG9kLCB1cmwgPSByZXEudXJsIH0gPSAoYXdhaXQgdGhpcy5fcHJlcmVxdWVzdChyZXEpKSB8fCByZXE7XG4gICAgY29uc3QgYWpheFJlcXVlc3RDb25maWc6IEFqYXhSZXF1ZXN0Q29uZmlnID0ge1xuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczogeyAuLi5yZXEuaGVhZGVycywgLi4uaGVhZGVycyB9LFxuICAgICAgdXJsLFxuICAgICAgZGF0YTogYm9keSxcbiAgICAgIHJlc3BvbnNlVHlwZTogdGhpcy5vcHRpb25zLnJlc3BvbnNlVHlwZSA/PyB0aGlzLnJlc3BvbnNlVHlwZSxcbiAgICAgIHdpdGhDcmVkZW50aWFsczogISF0aGlzLm9wdGlvbnMud2l0aENyZWRlbnRpYWxzLFxuICAgICAgY2FuY2VsZXI6IHRoaXMuY2FuY2VsZXIsXG4gICAgICBzaWduYWwsXG4gICAgICB2YWxpZGF0ZVN0YXR1czogKCkgPT4gdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMucmV0cnkuY29uZmlnLnRpbWVvdXRcbiAgICB9O1xuICAgIGlmIChpc051bWJlcih0aGlzLm9mZnNldCkgJiYgYm9keSAmJiB0eXBlb2YgYm9keSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGFqYXhSZXF1ZXN0Q29uZmlnLm9uVXBsb2FkUHJvZ3Jlc3MgPSB0aGlzLm9uUHJvZ3Jlc3MoKTtcbiAgICB9XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmFqYXgucmVxdWVzdChhamF4UmVxdWVzdENvbmZpZyk7XG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlLmRhdGE7XG4gICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHRoaXMucmVzcG9uc2VTdGF0dXMgPSByZXNwb25zZS5zdGF0dXM7XG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA+PSA0MDApIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgYXV0aCB0b2tlbiBzdHJpbmdcbiAgICovXG4gIHVwZGF0ZVRva2VuID0gKCk6IHN0cmluZyB8IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgcmV0dXJuIHVuZnVuYyh0aGlzLnRva2VuIHx8ICcnLCB0aGlzLnJlc3BvbnNlU3RhdHVzKTtcbiAgfTtcblxuICAvKipcbiAgICogR2V0IGZpbGUgVVJJXG4gICAqL1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0RmlsZVVybCgpOiBQcm9taXNlPHN0cmluZz47XG5cbiAgLyoqXG4gICAqIFNlbmQgZmlsZSBjb250ZW50IGFuZCByZXR1cm4gYW4gb2Zmc2V0IGZvciB0aGUgbmV4dCByZXF1ZXN0XG4gICAqL1xuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2VuZEZpbGVDb250ZW50KCk6IFByb21pc2U8bnVtYmVyIHwgdW5kZWZpbmVkPjtcblxuICAvKipcbiAgICogR2V0IGFuIG9mZnNldCBmb3IgdGhlIG5leHQgcmVxdWVzdFxuICAgKi9cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldE9mZnNldCgpOiBQcm9taXNlPG51bWJlciB8IHVuZGVmaW5lZD47XG5cbiAgLyoqXG4gICAqICBVcGRhdGluZyB0aGUgbWV0YWRhdGEgb2YgdGhlIHVwbG9hZFxuICAgKi9cbiAgcHJvdGVjdGVkIHVwZGF0ZTxUID0geyBtZXRhZGF0YT86IE1ldGFkYXRhIH0+KF9kYXRhOiBUKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ05vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFib3J0KCk6IHZvaWQge1xuICAgIHRoaXMub2Zmc2V0ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuYWJvcnRDb250cm9sbGVyLmFib3J0KCk7XG4gICAgdGhpcy5jYW5jZWxlci5jYW5jZWwoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBjYW5jZWwoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5hYm9ydCgpO1xuICAgIGlmICh0aGlzLnVybCkge1xuICAgICAgYXdhaXQgdGhpcy5yZXF1ZXN0KHsgbWV0aG9kOiAnREVMRVRFJyB9KS5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIHZhbHVlIGZyb20gdGhlIHJlc3BvbnNlXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0VmFsdWVGcm9tUmVzcG9uc2Uoa2V5OiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5yZXNwb25zZUhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldIHx8IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGZpbGUgY2h1bmtcbiAgICogQHBhcmFtIG9mZnNldCAtIG51bWJlciBvZiBieXRlcyBvZiB0aGUgZmlsZSB0byBza2lwXG4gICAqIEBwYXJhbSBzaXplIC0gY2h1bmsgc2l6ZVxuICAgKi9cbiAgZ2V0Q2h1bmsob2Zmc2V0PzogbnVtYmVyLCBzaXplPzogbnVtYmVyKTogeyBzdGFydDogbnVtYmVyOyBlbmQ6IG51bWJlcjsgYm9keTogQmxvYiB9IHtcbiAgICBpZiAodGhpcy5yZXNwb25zZVN0YXR1cyA9PT0gNDEzKSB7XG4gICAgICBEeW5hbWljQ2h1bmsubWF4U2l6ZSA9IER5bmFtaWNDaHVuay5zaXplID0gTWF0aC5mbG9vcihEeW5hbWljQ2h1bmsuc2l6ZSAvIDIpO1xuICAgIH1cbiAgICB0aGlzLmNodW5rU2l6ZSA9XG4gICAgICB0aGlzLm9wdGlvbnMuY2h1bmtTaXplID09PSAwID8gdGhpcy5zaXplIDogdGhpcy5vcHRpb25zLmNodW5rU2l6ZSB8fCBEeW5hbWljQ2h1bmsuc2l6ZTtcbiAgICBjb25zdCBzdGFydCA9IG9mZnNldCA/PyB0aGlzLm9mZnNldCA/PyAwO1xuICAgIGNvbnN0IGVuZCA9IE1hdGgubWluKHN0YXJ0ICsgKHNpemUgfHwgdGhpcy5jaHVua1NpemUpLCB0aGlzLnNpemUpO1xuICAgIGNvbnN0IGJvZHkgPSB0aGlzLmZpbGUuc2xpY2Uoc3RhcnQsIGVuZCk7XG4gICAgcmV0dXJuIHsgc3RhcnQsIGVuZCwgYm9keSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZXRyeUFmdGVyRnJvbUJhY2tlbmQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTnVtYmVyKHRoaXMuZ2V0VmFsdWVGcm9tUmVzcG9uc2UoJ3JldHJ5LWFmdGVyJykpICogMTAwMDtcbiAgfVxuXG4gIHByaXZhdGUgY2FuY2VsQW5kU2VuZFN0YXRlKCkge1xuICAgIHRoaXMuY2FuY2VsKCkudGhlbigoKSA9PiB0aGlzLnN0YXRlQ2hhbmdlKHRoaXMpLCBjb25zb2xlLmVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlQW5kU2VuZFN0YXRlKCk6IHZvaWQge1xuICAgIHRoaXMudXBkYXRlKHsgbWV0YWRhdGE6IHRoaXMubWV0YWRhdGEgfSkudGhlbigoKSA9PiB0aGlzLnN0YXRlQ2hhbmdlKHRoaXMpLCBjb25zb2xlLmVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW51cCA9ICgpID0+IHtcbiAgICBzdG9yZS5kZWxldGUodGhpcy5fdXJsKTtcbiAgICBzdG9yZS5kZWxldGUodGhpcy51cGxvYWRJZCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBvblByb2dyZXNzKCk6IChldnQ6IFByb2dyZXNzRXZlbnQpID0+IHZvaWQge1xuICAgIGxldCB0aHJvdHRsZTogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD4gfCB1bmRlZmluZWQ7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICByZXR1cm4gKHsgbG9hZGVkIH0pID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSBsb2FkZWQgLyAoKERhdGUubm93KCkgLSBzdGFydFRpbWUpIC8gMTAwMCk7XG4gICAgICB0aGlzLnNwZWVkID0gfn4oKHRoaXMuc3BlZWQgKiB0aGlzLl9ldmVudHNDb3VudCArIGN1cnJlbnQpIC8gKyt0aGlzLl9ldmVudHNDb3VudCk7XG4gICAgICBEeW5hbWljQ2h1bmsuc2NhbGUodGhpcy5zcGVlZCk7XG4gICAgICBpZiAoIXRocm90dGxlKSB7XG4gICAgICAgIHRocm90dGxlID0gc2V0VGltZW91dCgoKSA9PiAodGhyb3R0bGUgPSB1bmRlZmluZWQpLCA1MDApO1xuICAgICAgICBjb25zdCB1cGxvYWRlZCA9ICh0aGlzLm9mZnNldCB8fCAwKSArIGxvYWRlZDtcbiAgICAgICAgdGhpcy5wcm9ncmVzcyA9ICsoKHVwbG9hZGVkIC8gdGhpcy5zaXplKSAqIDEwMCkudG9GaXhlZCgyKTtcbiAgICAgICAgdGhpcy5yZW1haW5pbmcgPSB+figodGhpcy5zaXplIC0gdXBsb2FkZWQpIC8gdGhpcy5zcGVlZCk7XG4gICAgICAgIHRoaXMuc3RhdGVDaGFuZ2UodGhpcyk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuIl19
import{a as D}from"./chunk-6C7DPHTS.js";import{a as G}from"./chunk-4XL6BJ7M.js";import{a as M,b as W}from"./chunk-RBCGTDIC.js";import{$ as h,Af as S,B as o,Gc as y,Gf as z,Ic as T,Id as O,Kc as U,N as R,Qf as j,R as p,T as d,Ue as A,Y as I,c as E,e as x,fe as _,gg as B,hf as w,hg as Y,j as b,kg as k,m as u,qe as C,v as g,wf as N,x as L,yf as H,zf as V}from"./chunk-4A7FW7VV.js";import{g as q,j as s}from"./chunk-K6ICEIKK.js";var J=q(z());var v=class{constructor(t,e={}){s(this,"id");s(this,"position");s(this,"startTimestamp");s(this,"stopTimestamp");s(this,"type");s(this,"video");this.id=t.id,this.position=t.position,this.startTimestamp=t.startTimestamp,this.stopTimestamp=t.stopTimestamp,this.type=t.type,t.video&&(this.video=new G(t.video,e))}};var P=class{constructor(t,e){s(this,"id");s(this,"uuid");s(this,"shortUUID");s(this,"isLocal");s(this,"url");s(this,"displayName");s(this,"description");s(this,"privacy");s(this,"videosLength");s(this,"type");s(this,"createdAt");s(this,"updatedAt");s(this,"ownerAccount");s(this,"videoChannel");s(this,"thumbnailPath");s(this,"thumbnailUrl");s(this,"embedPath");s(this,"embedUrl");s(this,"ownerBy");s(this,"videoChannelBy");let i=N();this.id=t.id,this.uuid=t.uuid,this.shortUUID=t.shortUUID,this.url=t.url,this.isLocal=t.isLocal,this.displayName=t.displayName,this.description=t.description,this.privacy=t.privacy,this.thumbnailPath=t.thumbnailPath,this.thumbnailUrl=this.thumbnailPath?t.thumbnailUrl||i+t.thumbnailPath:i+"/client/assets/images/default-playlist.jpg",this.embedPath=t.embedPath,this.embedUrl=t.embedUrl||H()+t.embedPath,this.videosLength=t.videosLength,this.type=t.type,this.createdAt=new Date(t.createdAt),this.updatedAt=new Date(t.updatedAt),this.ownerAccount=t.ownerAccount,this.ownerBy=S.CREATE_BY_STRING(t.ownerAccount.name,t.ownerAccount.host),t.videoChannel&&(this.videoChannel=t.videoChannel,this.videoChannelBy=S.CREATE_BY_STRING(t.videoChannel.name,t.videoChannel.host)),this.privacy.label=C(this.privacy.label,e),this.type.id===O.WATCH_LATER&&(this.displayName=C(this.displayName,e))}static buildWatchUrl(t){return _({shortUUID:t.shortUUID||t.uuid})}};var f=(0,J.default)("peertube:playlists:VideoPlaylistService"),n=class n{constructor(t,e,i,a,r){this.authHttp=t;this.auth=e;this.serverService=i;this.restExtractor=a;this.restService=r;s(this,"videoExistsInPlaylistNotifier",new x(1));s(this,"videoExistsInPlaylistCacheSubject",new E);s(this,"videoExistsInPlaylistObservable");s(this,"videoExistsObservableCache",{});s(this,"videoExistsCache",{});s(this,"myAccountPlaylistCache");s(this,"myAccountPlaylistCacheRunning");s(this,"myAccountPlaylistCacheSubject",new E);this.videoExistsInPlaylistObservable=g(w({time:200,bulkGet:l=>this.auth.isLoggedIn()?this.doVideosExistInPlaylist(l):b({}),notifierObservable:this.videoExistsInPlaylistNotifier}).pipe(u(({response:l})=>l)),this.videoExistsInPlaylistCacheSubject)}listChannelPlaylists(t,e){let i=W.BASE_VIDEO_CHANNEL_URL+t.nameWithHost+"/video-playlists",a=this.restService.componentToRestPagination(e),r=new y;return r=this.restService.addRestGetParams(r,a),this.authHttp.get(i,{params:r}).pipe(p(l=>this.extractPlaylists(l)),o(l=>this.restExtractor.handleError(l)))}listMyPlaylistWithCache(t,e){if(!e){if(this.myAccountPlaylistCacheRunning)return this.myAccountPlaylistCacheRunning;if(this.myAccountPlaylistCache)return b(this.myAccountPlaylistCache)}let i=this.listAccountPlaylists(t.account,void 0,"-updatedAt",e).pipe(d(a=>{e||(this.myAccountPlaylistCacheRunning=void 0,this.myAccountPlaylistCache=a)}),R());return e||(this.myAccountPlaylistCacheRunning=i),i}listAccountPlaylists(t,e,i,a){let r=M.BASE_ACCOUNT_URL+t.nameWithHost+"/video-playlists",l=e?this.restService.componentToRestPagination(e):void 0,c=new y;return c=this.restService.addRestGetParams(c,l,i),a&&(c=this.restService.addObjectParams(c,{search:a})),this.authHttp.get(r,{params:c}).pipe(p(m=>this.extractPlaylists(m)),o(m=>this.restExtractor.handleError(m)))}getVideoPlaylist(t){let e=n.BASE_VIDEO_PLAYLIST_URL+t;return this.authHttp.get(e).pipe(p(i=>this.extractPlaylist(i)),o(i=>this.restExtractor.handleError(i)))}createVideoPlaylist(t){let e=V(t);return this.authHttp.post(n.BASE_VIDEO_PLAYLIST_URL,e).pipe(d(i=>{this.myAccountPlaylistCache&&(this.myAccountPlaylistCache.total++,this.myAccountPlaylistCache.data.push({id:i.videoPlaylist.id,displayName:t.displayName}),this.myAccountPlaylistCacheSubject.next(this.myAccountPlaylistCache))}),o(i=>this.restExtractor.handleError(i)))}updateVideoPlaylist(t,e){let i=V(e);return this.authHttp.put(n.BASE_VIDEO_PLAYLIST_URL+t.id,i).pipe(d(()=>{if(!this.myAccountPlaylistCache)return;let a=this.myAccountPlaylistCache.data.find(r=>r.id===t.id);a.displayName=e.displayName,this.myAccountPlaylistCacheSubject.next(this.myAccountPlaylistCache)}),o(a=>this.restExtractor.handleError(a)))}removeVideoPlaylist(t){return this.authHttp.delete(n.BASE_VIDEO_PLAYLIST_URL+t.id).pipe(d(()=>{this.myAccountPlaylistCache&&(this.myAccountPlaylistCache.total--,this.myAccountPlaylistCache.data=this.myAccountPlaylistCache.data.filter(e=>e.id!==t.id),this.myAccountPlaylistCacheSubject.next(this.myAccountPlaylistCache))}),o(e=>this.restExtractor.handleError(e)))}addVideoInPlaylist(t,e){let i=n.BASE_VIDEO_PLAYLIST_URL+t+"/videos";return this.authHttp.post(i,e).pipe(d(a=>{if(this.videoExistsCache[e.videoId].push({playlistId:t,playlistElementId:a.videoPlaylistElement.id,startTimestamp:e.startTimestamp,stopTimestamp:e.stopTimestamp}),this.runVideoExistsInPlaylistCheck(e.videoId),this.myAccountPlaylistCache){let l=this.myAccountPlaylistCache.data.find(m=>m.id===t);if(!l)return;let c=this.myAccountPlaylistCache.data.filter(m=>m!==l);this.myAccountPlaylistCache.data=[l,...c]}}),o(a=>this.restExtractor.handleError(a)))}updateVideoOfPlaylist(t,e,i,a){return this.authHttp.put(n.BASE_VIDEO_PLAYLIST_URL+t+"/videos/"+e,i).pipe(d(()=>{let r=this.videoExistsCache[a];if(r){let l=r.find(c=>c.playlistElementId===e);l.startTimestamp=i.startTimestamp,l.stopTimestamp=i.stopTimestamp}this.runVideoExistsInPlaylistCheck(a)}),o(r=>this.restExtractor.handleError(r)))}removeVideoFromPlaylist(t,e,i){return this.authHttp.delete(n.BASE_VIDEO_PLAYLIST_URL+t+"/videos/"+e).pipe(d(()=>{i&&(this.videoExistsCache[i]&&(this.videoExistsCache[i]=this.videoExistsCache[i].filter(a=>a.playlistElementId!==e)),this.runVideoExistsInPlaylistCheck(i))}),o(a=>this.restExtractor.handleError(a)))}reorderPlaylist(t,e,i){let a={startPosition:e,insertAfterPosition:i};return this.authHttp.post(n.BASE_VIDEO_PLAYLIST_URL+t+"/videos/reorder",a).pipe(o(r=>this.restExtractor.handleError(r)))}getPlaylistVideos(t){let e=n.BASE_VIDEO_PLAYLIST_URL+t.videoPlaylistId+"/videos",i=this.restService.componentToRestPagination(t.componentPagination),a=new y;return a=this.restService.addRestGetParams(a,i),this.authHttp.get(e,{params:a}).pipe(p(r=>this.extractVideoPlaylistElements(r)),o(r=>this.restExtractor.handleError(r)))}listenToMyAccountPlaylistsChange(){return this.myAccountPlaylistCacheSubject.asObservable()}listenToVideoPlaylistChange(t){if(this.videoExistsObservableCache[t])return this.videoExistsObservableCache[t];let e=this.videoExistsInPlaylistObservable.pipe(u(i=>i[t]),L(i=>!!i),d(i=>this.videoExistsCache[t]=i));return this.videoExistsObservableCache[t]=e,e}runVideoExistsInPlaylistCheck(t){return f("Running playlist check."),this.videoExistsCache[t]?(f("Found cache for %d.",t),this.videoExistsInPlaylistCacheSubject.next({[t]:this.videoExistsCache[t]})):(f("Fetching from network for %d.",t),this.videoExistsInPlaylistNotifier.next(t))}extractPlaylists(t){return this.serverService.getServerLocale().pipe(u(e=>{let i=t.data,a=t.total,r=[];for(let l of i)r.push(new P(l,e));return{data:r,total:a}}))}extractPlaylist(t){return this.serverService.getServerLocale().pipe(u(e=>new P(t,e)))}extractVideoPlaylistElements(t){return this.serverService.getServerLocale().pipe(u(e=>{let i=t.data,a=t.total,r=[];for(let l of i)r.push(new v(l,e));return{total:a,data:r}}))}doVideosExistInPlaylist(t){let e=n.MY_VIDEO_PLAYLIST_URL+"videos-exist",i=new y;return i=this.restService.addObjectParams(i,{videoIds:t}),this.authHttp.get(e,{params:i,context:new T().set(D,!0)}).pipe(o(a=>this.restExtractor.handleError(a)))}};s(n,"BASE_VIDEO_PLAYLIST_URL",A.apiUrl+"/api/v1/video-playlists/"),s(n,"MY_VIDEO_PLAYLIST_URL",A.apiUrl+"/api/v1/users/me/video-playlists/"),s(n,"\u0275fac",function(e){return new(e||n)(h(U),h(Y),h(j),h(B),h(k))}),s(n,"\u0275prov",I({token:n,factory:n.\u0275fac}));var F=n;export{P as a,F as b};
/**i18n:2f710d33ac9c4f1483429afcadbb48fcf333aac524700807e70179670fe63b48*/
